import re
import json
import os

new_raw_text = """PozNo | Tanım | Birim | Fiyat
10.130.2502 | 7,5 cm kalınlıkta techizatsız gazbeton duvar bloğu | m² | 133,40 10.130.2503 | 8,5 cm kalınlıkta techizatsız gazbeton duvar bloğu | m² | 151,20 10.130.2504 | 9 cm kalınlıkta techizatsız gazbeton duvar bloğu | m² | 160,00 10.130.2505 | 10 cm kalınlıkta techizatsız gazbeton duvar bloğu | m² | 177,90 10.130.2506 | 12,5 cm kalınlıkta techizatsız gazbeton duvar bloğu | m² | 222,30 10.130.2507 | 13,5cm kalınlıkta techizatsız gazbeton duvar bloğu | m² | 240,15 10.130.2508 | 15 cm kalınlıkta techizatsız gazbeton duvar bloğu | m² | 266,80 10.130.2509 | 17,5 cm kalınlıkta techizatsız gazbeton duvar bloğu | m² | 311,30 10.130.2510 | 19 cm kalınlıkta techizatsız gazbeton duvar bloğu | m² | 337,95 10.130.2511 | 20 cm kalınlıkta techizatsız gazbeton duvar bloğu | m² | 355,75 10.130.2512 | 22,5 cm kalınlıkta techizatsız gazbeton duvar bloğu | m² | 400,20 10.130.2513 | 25 cm kalınlıkta techizatsız gazbeton duvar bloğu | m² | 444,70 10.130.2514 | 27,5 cm kalınlıkta techizatsız gazbeton duvar bloğu | m² | 489,15 10.130.2515 | 30 cm kalınlıkta techizatsız gazbeton duvar bloğu | m² | 533,60 10.130.2516 | 32,5 cm kalınlıkta techizatsız gazbeton duvar bloğu | m² | 578,00 10.130.2517 | 35 cm kalınlıkta techizatsız gazbeton duvar bloğu | m² | 622,50 10.130.2531 | Techizatsız gazbeton duvar blokları (3,50 N/mm² ve 500 kg/m³) | m³ | 1.998,00 10.130.2532 | 7,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (500 kg/m³) | m² | 149,86 10.130.2533 | 8,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (500 kg/m³) | m² | 169,85 10.130.2534 | 9 cm kalınlıkta techizatsız gazbeton duvar bloğu (500 kg/m³) | m² | 179,83 10.130.2535 | 10 cm kalınlıkta techizatsız gazbeton duvar bloğu (500 kg/m³) | m² | 199,81 10.130.2536 | 12,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (500 kg/m³) | m² | 249,77 10.130.2537 | 13,5cm kalınlıkta techizatsız gazbeton duvar bloğu (500 kg/m³) | m² | 269,75 10.130.2538 | 15 cm kalınlıkta techizatsız gazbeton duvar bloğu (500 kg/m³) | m² | 299,71 10.130.2539 | 17,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (500 kg/m³) | m² | 349,67 10.130.2540 | 19 cm kalınlıkta techizatsız gazbeton duvar bloğu (500 kg/m³) | m² | 379,64 10.130.2541 | 20 cm kalınlıkta techizatsız gazbeton duvar bloğu (500 kg/m³) | m² | 399,62 10.130.2542 | 22,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (500 kg/m³) | m² | 449,60 10.130.2543 | 25 cm kalınlıkta techizatsız gazbeton duvar bloğu (500 kg/m³) | m² | 499,52 10.130.2544 | 27,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (500 kg/m³) | m² | 549,48 10.130.2545 | 30 cm kalınlıkta techizatsız gazbeton duvar bloğu (500 kg/m³) | m² | 599,42 10.130.2546 | 32,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (500 kg/m³) | m² | 649,38 10.130.2547 | 35 cm kalınlıkta techizatsız gazbeton duvar bloğu (500 kg/m³) | m² | 699,33 10.130.2561 | Teçhizatsız gazbeton duvar blokları (5,00 N/mm² ve 600 kg/m³) | m³ | 2.115,00 10.130.2562 | 7,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (600 kg/m³) | m² | 158,69 10.130.2563 | 8,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (600 kg/m³) | m² | 179,85 10.130.2564 | 9 cm kalınlıkta techizatsız gazbeton duvar bloğu (600 kg/m³) | m² | 190,43 10.130.2565 | 10 cm kalınlıkta techizatsız gazbeton duvar bloğu (600 kg/m³) | m² | 211,58 10.130.2566 | 12,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (600 kg/m³) | m² | 264,49 10.130.2567 | 13,5cm kalınlıkta techizatsız gazbeton duvar bloğu (600 kg/m³) | m² | 285,64 10.130.2568 | 15 cm kalınlıkta techizatsız gazbeton duvar bloğu (600 kg/m³) | m² | 317,38 10.130.2569 | 17,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (600 kg/m³) | m² | 370,28 10.130.2570 | 19 cm kalınlıkta techizatsız gazbeton duvar bloğu (600 kg/m³) | m² | 402,01 10.130.2571 | 20 cm kalınlıkta techizatsız gazbeton duvar bloğu (600 kg/m³) | m² | 423,17 10.130.2572 | 22,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (600 kg/m³) | m² | 476,07 10.130.2573 | 25 cm kalınlıkta techizatsız gazbeton duvar bloğu (600 kg/m³) | m² | 528,96 10.130.2574 | 27,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (600 kg/m³) | m² | 581,86 10.130.2575 | 30 cm kalınlıkta techizatsız gazbeton duvar bloğu (600 kg/m³) | m² | 634,75 10.130.2576 | 32,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (600 kg/m³) | m² | 687,65 10.130.2577 | 35 cm kalınlıkta techizatsız gazbeton duvar bloğu (600 kg/m³) | m² | 740,54 10.130.2591 | Techizatsız gazbeton duvar blokları (≥ 2,00 N/mm² ve 350 kg/m³) | m³ | 1.896,00 10.130.2592 | 7,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (350 kg/m³) | m² | 142,27 10.130.2593 | 8,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (350 kg/m³) | m² | 161,64 10.130.2594 | 9 cm kalınlıkta techizatsız gazbeton duvar bloğu (350 kg/m³) | m² | 170,73 10.130.2595 | 10 cm kalınlıkta techizatsız gazbeton duvar bloğu (350 kg/m³) | m² | 189,70 10.130.2596 | 12,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (350 kg/m³) | m² | 237,12 10.130.2597 | 13,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (350 kg/m³) | m² | 256,09 10.130.2598 | 15 cm kalınlıkta techizatsız gazbeton duvar bloğu (350 kg/m³) | m² | 284,54 10.130.2599 | 17,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (350 kg/m³) | m² | 331,97 10.130.2600 | 19 cm kalınlıkta techizatsız gazbeton duvar bloğu (350 kg/m³) | m² | 360,42 10.130.2601 | 20 cm kalınlıkta techizatsız gazbeton duvar bloğu (350 kg/m³) | m² | 379,39 10.130.2602 | 22,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (350 kg/m³) | m² | 426,82 10.130.2603 | 25 cm kalınlıkta techizatsız gazbeton duvar bloğu (350 kg/m³) | m² | 474,25 10.130.2604 | 27,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (350 kg/m³) | m² | 521,66 10.130.2605 | 30 cm kalınlıkta techizatsız gazbeton duvar bloğu (350 kg/m³) | m² | 569,09 10.130.2606 | 32,5 cm kalınlıkta techizatsız gazbeton duvar bloğu (350 kg/m³) | m² | 616,51 10.130.2607 | 35 cm kalınlıkta techizatsız gazbeton duvar bloğu (350 kg/m³) | m² | 663,94 10.130.2621 | Gazbeton asmolen blokları (2,50 N/mm² ve 400 kg/m³) | m³ | 1.750,00 10.130.2622 | 15 cm yükseklikte gazbeton asmolen bloğu | m² | 262,31 10.130.2623 | 17,5 cm yükseklikte gazbeton asmolen bloğu | m² | 306,03 10.130.2624 | 20 cm yükseklikte gazbeton asmolen bloğu | m² | 349,75 10.130.2625 | 22,5 cm yükseklikte gazbeton asmolen bloğu | m² | 393,47 10.130.2626 | 25 cm yükseklikte gazbeton asmolen bloğu | m² | 437,19 10.130.2627 | 27,5 cm yükseklikte gazbeton asmolen bloğu | m² | 480,91 10.130.2628 | 30 cm yükseklikte gazbeton asmolen bloğu | m² | 524,63 10.130.2641 | Techizatlı gazbeton lento (3,50 N/mm² ve 500 kg/m³) | m³ | 5.248,00 10.130.2642 | 7,5 cm kalınlıkta techizatlı gazbeton lento | m² | 393,60 10.130.2643 | 8,5 cm kalınlıkta techizatlı gazbeton lento | m² | 446,08 10.130.2644 | 9 cm kalınlıkta techizatlı gazbeton lento | m² | 472,32 10.130.2645 | 10 cm kalınlıkta techizatlı gazbeton lento | m² | 524,08 10.130.2646 | 12,5 cm kalınlıkta techizatlı gazbeton lento | m² | 656,00 10.130.2647 | 13,5cm kalınlıkta techizatlı gazbeton lento | m² | 708,48 10.130.2648 | 15 cm kalınlıkta techizatlı gazbeton lento | m² | 787,20 10.130.2649 | 17,5 cm kalınlıkta techizatlı gazbeton lento | m² | 918,40 10.130.2650 | 19 cm kalınlıkta techizatlı gazbeton lento | m² | 997,12 10.130.2651 | 20 cm kalınlıkta techizatlı gazbeton lento | m² | 1.049,60 10.130.2652 | 22,5 cm kalınlıkta techizatlı gazbeton lento | m² | 1.180,80 10.130.2653 | 25 cm kalınlıkta techizatlı gazbeton lento | m² | 1.312,00 10.130.2654 | 27,5 cm kalınlıkta techizatlı gazbeton lento | m² | 1.443,20 10.130.2655 | 30 cm kalınlıkta techizatlı gazbeton lento | m² | 1.574,40 10.130.2656 | 32,5 cm kalınlıkta techizatlı gazbeton lento | m² | 1.705,60 10.130.2657 | 35 cm kalınlıkta techizatlı gazbeton lento | m² | 1.836,80 10.130.2671 | Techizatlı gazbeton lento (5,00 N/mm² ve 600 kg/m³) | m³ | 5.544,00 10.130.2672 | 7,5 cm kalınlıkta techizatlı gazbeton lento (600 kg/m³) | m² | 415,87 10.130.2673 | 8,5 cm kalınlıkta techizatlı gazbeton lento (600 kg/m³) | m² | 471,32 10.130.2674 | 9 cm kalınlıkta techizatlı gazbeton lento (600 kg/m³) | m² | 499,05 10.130.2675 | 10 cm kalınlıkta techizatlı gazbeton lento (600 kg/m³) | m² | 554,50 10.130.2676 | 12,5 cm kalınlıkta techizatlı gazbeton lento (600 kg/m³) | m² | 693,12 10.130.2677 | 13,5cm kalınlıkta techizatlı gazbeton lento (600 kg/m³) | m² | 748,57 10.130.2678 | 15 cm kalınlıkta techizatlı gazbeton lento (600 kg/m³) | m² | 831,74"""

def append_to_json(text, filename='src/pozlar_2025.json'):
    # Regex deseni (Bitişik verileri ayırmak için optimize edildi)
    # Fiyat kısmı için (\d+[\.,]\d+) benzeri bir yapı gerekiyor ama sondaki kuruş hanesi virgül ile ayrılıyor.
    # Örnekler: 133,40 (nokta yok), 1.998,00 (nokta var).
    # Bu yüzden [\d\.]+,\d{2} deseni kullanıyoruz.
    pattern = r"(\d{2}\.\d{3}\.\d{4})\s*\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|\s*([\d\.]+,\d{2})"
    matches = re.findall(pattern, text)

    new_items = []
    for match in matches:
        # Fiyat dönüşümü: Önce binlik ayracı olan noktaları sil, sonra ondalık ayracı olan virgülü noktaya çevir.
        fiyat_str = match[3].replace('.', '').replace(',', '.')
        new_items.append({
            "pozNo": match[0].strip(),
            "tanim": match[1].strip(),
            "birim": match[2].strip(),
            "birimFiyat": float(fiyat_str),
            "kurum": "ÇŞB",
            "yil": 2025
        })

    # Eğer dosya zaten varsa mevcut veriyi oku
    existing_data = []
    if os.path.exists(filename):
        with open(filename, 'r', encoding='utf-8') as f:
            try:
                existing_data = json.load(f)
            except json.JSONDecodeError:
                existing_data = []

    # Yeni verileri eskilere ekle (Tekrar edenleri engellemek için set kullanılabilir ama şimdilik düz ekliyoruz)
    combined_data = existing_data + new_items

    # Güncel listeyi kaydeder
    with open(filename, 'w', encoding='utf-8') as f:
        json.dump(combined_data, f, ensure_ascii=False, indent=2)

    print(f"İşlem Tamam! Toplam Poz Sayısı: {len(combined_data)}")

# Çalıştır
append_to_json(new_raw_text)
